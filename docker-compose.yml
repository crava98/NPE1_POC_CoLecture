services:
  # 1. Der Agent (Client)
  agent-app:
    build: .
    container_name: agent-client
    depends_on:
      - mcp-server
    volumes:
      - .:/app
      # Beide brauchen Zugriff auf die Daten: Der Client zum Hochladen...
      - ./data:/app/storage
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
      # Der Agent muss wissen, wo der Server ist
      - MCP_SERVER_URL=http://mcp-server:8000/sse
      # Set in Portainer or .env file
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-}
      - N8N_AUTH_TOKEN=${N8N_AUTH_TOKEN:-}

  # 2. Der MCP Server (Tool Provider)
  mcp-server:
    build: .
    container_name: mcp-server
    # Ruft das Objekt 'app' im Modul 'mcp_server' auf
    entrypoint: ["uvicorn", "mcp_server:app", "--host", "0.0.0.0", "--port", "8000"]
    volumes:
      - .:/app
      - ./data:/data
    ports:
      - "8010:8000"
    environment:
      - PYTHONUNBUFFERED=1

  # 3. ngrok f√ºr den externen Zugriff (optional)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok-tunnel
    profiles:
      - external  # Nur starten mit: docker-compose --profile external up
    depends_on:
      - agent-app
    ports:
      - "4040:4040"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}
    command: ["http", "--basic-auth", "Student:hslu5in5rotkreuz", "agent-app:8501"]