services:
  # 1. Der Agent (Client)
  agent-app:
    build: .
    container_name: agent-client
    depends_on:
      - mcp-server
    volumes:
      # Nur Daten-Volumes, NICHT .:/app (überschreibt Source Code im Container)
      - ppt-data:/app/storage
    ports:
      - "${AGENT_PORT:-8501}:8501"
    environment:
      - PYTHONUNBUFFERED=1
      - MCP_SERVER_URL=http://mcp-server:8000/sse
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-}
      - N8N_AUTH_TOKEN=${N8N_AUTH_TOKEN:-}

  # 2. Der MCP Server (Tool Provider)
  mcp-server:
    build: .
    container_name: mcp-server
    entrypoint: ["uvicorn", "mcp_server:app", "--host", "0.0.0.0", "--port", "8000"]
    volumes:
      # Daten-Volume für PDFs und Templates
      - ppt-data:/data
    ports:
      - "${MCP_PORT:-8020}:8000"
    environment:
      - PYTHONUNBUFFERED=1

  # 3. ngrok für den externen Zugriff (optional)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok-tunnel
    profiles:
      - external
    depends_on:
      - agent-app
    ports:
      - "4040:4040"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}
    command: ["http", "--basic-auth", "Student:hslu5in5rotkreuz", "agent-app:8501"]

volumes:
  ppt-data:
    driver: local
